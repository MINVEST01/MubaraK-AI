# =================================================================
# == Этап 1: Сборщик (Builder)                                   ==
# =================================================================
# Этот этап устанавливает зависимости в изолированное окружение.

FROM python:3.11-slim as builder

# Устанавливаем рабочую директорию
WORKDIR /app

# Устанавливаем переменную окружения, чтобы pip не кэшировал пакеты
ENV PIP_NO_CACHE_DIR=1

# Создаем виртуальное окружение
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Копируем файл с зависимостями и устанавливаем их
COPY requirements.txt .
RUN pip install --upgrade pip && \
    pip install -r requirements.txt

# =================================================================
# == Этап 2: Финальный образ (Production)                        ==
# =================================================================
# Этот этап использует результаты предыдущего для создания легкого
# и безопасного образа для запуска приложения.

FROM python:3.11-slim

# Создаем непривилегированного пользователя для запуска приложения
RUN addgroup --system app && adduser --system --group app

WORKDIR /app

# Копируем виртуальное окружение и исходный код из этапа "builder"
COPY --from=builder /opt/venv /opt/venv
COPY . .


# Устанавливаем владельца файлов и переключаемся на нового пользователя
RUN chown -R app:app /app
USER app

# Обновляем PATH, чтобы использовать venv
ENV PATH="/opt/venv/bin:$PATH"

# Открываем порт, на котором будет работать приложение
EXPOSE 8000

# Команда для запуска приложения в production-режиме.
# Используем Gunicorn как воркер-менеджер для Uvicorn для большей надежности.
# Рекомендуется добавить 'gunicorn' в ваш requirements.txt
CMD ["gunicorn", "-k", "uvicorn.workers.UvicornWorker", "-w", "4", "-b", "0.0.0.0:8000", "src.main:create_app", "--factory"]